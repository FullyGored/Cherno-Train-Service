// Script by Zonekiller  -- http://zonekiller.ath.cx --    -- zonekiller@live.com.au --
//http://www.armaholic.com/page.php?id=16784
if !(isserver) exitwith {};

//add this to the init of the train

// this == train - 1 == if you want the gun on the back
// _nil = [this,1] execVM "Scripts\Train\Train_Start.sqf";

sleep .3;

// rail id numbers
_rail = [961656,961658,961660,961651,961676,961667,961669,961668,961671,961670,961672,961673,961684,961685,961706,961709,961688,961695,961699,961716,961717,961721,961718,961687,961732,961729,961728,961730,961739,961738,961737,961740,961744,961743,961742,961741,961745,961746,961747,961748,961752,961749,961750,961751,961755,961756,961757,961758,961753,961754,961759,961760,961761,961762,961764,961765,961763,961767,961766,961768,961769,961771,961770,961772,961773,961775,961774,961776,961777,961780,961778,961781,961779,961782,961783,961784,961785,961793,961786,961789,961790,961791,961787,961799,961795,961796,961804,961806,961805,961807,961803,961808,961809,961810,961811,961812,961813,961814,961815,961816,961818,961817,961819,961820,961821,961822,961823,961824,961825,961826,961827,961828,961829,961853,961838,961854,961844,961831,961834,961864,961857,961870,961876,961877,961880,961881,961884,961885,961886,961887,961882,961883,961888,961890,961892,961895,961896,961899,961901,961902,961903,961905,961907,961906,961909,961908,961910,961911,961912,961914,961913,961917,961916,961918,961925,961922,961923,961926,961927,961928,961929,961930,961931,961932,961933,961934,961935,961936,961938,961937,961939,961940,961941,961942,961944,961947,961943,961945,961946,961948,961949,961950,961951,961952,961953,961957,961954,961955,961956,961958,961959,961960,961961,961962,961963,961964,961965,961966,961967,961970,961971,961968,961969,961972,961974,961975,961973,962393,962395,962392,962394,962396,962397,962398,962401,962402,962399,962403,962400,962408,962407,962405,962409,962406,962404,962427,962430,962428,962429,962410,962413,962412,962414,962415,962411,962423,962425,962426,962424,962416,962417,962421,962422,962420,962419,962418,962390,962391,962754,962753,962750,962752,962749,962751,962746,962748,962745,962747,962744,962743,962742,962739,962737,962736,962741,962738,962740,962731,962734,962735,962443,962440,962730,962432,962433,962439,962438,962435,962434,962436,962437,962711,962710,962709,962708,962722,962720,962721,962718,962716,962717,962714,962713,962715,962712,962719,962705,962706,962704,962703,962707,962160,962726,962728,962727,962159,962161,962724,962723,962725,962162,962163,962164,962165,962166,962175,962177,962170,962173,962167,962372,962376,962377,962382,962380,962383,962384,962385,962386,962387,962388,962389,962229,962232,962233,962236,962235,962234,962231,962230,962367,962366,962361,962360,962359,962358,962365,962346,962345,962339,962338,962336,962254,962252,962260,962297,962295,962277,962276,962274,962273,962272,962248,962247,962245,962246,962239,962243,962238,962237,962242,962227,962226,962225,962228,962224,962222,962221,962223,962218,962216,962220,962215,962219,962217,962214,962212,962213,962211,962210,962209,962208,962207,962205,962206,962204,962201,962203,962200,962202,962199,962195,962196,962193,962198,962194,962197,962192,962191,962190,962189,962188,962184,962187,962186,962185,962183,962180,962179,962182,962181,962702,962701,962700,962699,962696,962698,962697,962695,962692,962693,962691,962688,962690,962686,962689,962687,962685,962682,962684,962683,962680,962678,962677,962679,962681,962675,962674,962676,962672,962669,962671,962670,962461,962462,962459,962460,962458,962457,962456,962445,962455,962453,962454,962451,962446,962450,962447,962448,962449,962452,962158,962156,962444,962157,962155,962481,962478,962479,962480,962464,962471,962472,962466,962465,962470,962467,962140,962141,962143,962142,962139,962138,962148,962151,962150,962147,962152,962154,962153,962137,962621,962596,962599,962605,962611,962610,962633,962625,962631,962628,967589,967604,967605,968323,962634,962581,962580,962583,962582,962584,962591,962585,962589,962588,962587,962590,962586,962578,962577,962579,962637,962636,962635,962573,962576,962575,962574,962571,962570,962572,962562,962567,962569,962568,962566,962564,962565,962563,962561,962560,962559,962558,962557,962556,962555,962551,962554,962553,962552,962550,962549,962548,962547,962546,962545,962544,962543,962542,962541,962540,962539,962538,962531,962533,962537,962535,962536,962534,962532,962530,962527,962529,962528,962526,962525,962524,962523,962521,962520,962522,962519,962518,962517,962085,962086,962117,962111,962106,962112,962116,962115,962114,962096,962097,962095,962094,962093,962092,962088,962089,962091,962090,962081,962084,962082,962083,962080,962128,962130,962131,962129,962122,962120,962121,962127,962126,962125,962124,962123,962077,962079,962078,962074,962075,962073,962076,962071,962072,962070,962069,962066,962068,962067,962064,962063,962065,962062,962061,962060,962059,962058,962056,962057,962055,962054,962053,962052,962051,962048,962049,962050,962047,962027,962029,962030,962028,962026,962025,962024,962022,962021,962020,962023,962019,962017,962018,962016,962009,962007,962008,962006,962005,962004,962003,962002,962001,962000,961999,961998,961997,961992,961991,961990,961995,961996,961993,962010,962013,962011,962012,962014,962015,961978,961976,961977,961987,961988,961985,961983,961986,961984,961989,961980,961981,961982,961979,962046,962045,962044,962042,962041,962043,962040,962039,962038,962037,962034,962033,962032,962035,962031,962036];

_mynum = count _rail;
_mynum = _mynum - 1; 

// rail id you want to stop at
_stops = [961656,961706,961809,961864,961899,961923,962415,962730,962339,962675,967605,962530,962114,962050];
// rail id you want to blow horn at
_hornblow = [961651,961721,961740,961755,961778,961786,961884,961916,961947,962731,962380,962360,962272,962220,962194,962672,962447,962148,962154,962634,962534,962097,962030];

_train = _this select 0;
_bsn = _this select 1;

// train settings
_stoptime = 10;
_topspeed = 55;

_pos = position _train;
_wf = "Land_wagon_flat" createVehicle _pos;
_bs = "Ikarus_TK_CIV_EP1" createVehicle _pos;
_cars = [_wf,_bs];

// spawned sounds ,gun and train bend

	[_train] spawn {
	_train = _this select 0;
	_delay = 1.5;

		while {true} do
		{
		_sound = if (speed _train < 10) then {"engine"}else{"train"};
		//if (speed _train < 10) then {_delay = 1.5}else{_delay = 5.5};
		_initCode = "this say3D " + str(_sound);
		_train setVehicleInit _initCode; 
		processInitCommands;
		clearVehicleInit _train;
		sleep _delay;
		};

	};

	_horn = {
	_train = _this select 0;
	_initCode = "this say3D 'trainhorn'";
	_train setVehicleInit _initCode; 
	processInitCommands;
	clearVehicleInit _train;
	};

	_link = {
	_newdir = _this select 0;
	_train = _this select 1;
	_car = _this select 2;
	_trackpos = _this select 3;
	_curve = true;
	_newdir = _newdir / 1.5;
	_car setdir _newdir;
	_dis = _car distance _train;

		while {_curve} do
		{
		_dir1 = round direction _train;
		sleep .5;
		_dir2 = round direction _train;
		_pos = if (_dir1 == _dir2) then {position _car}else{[0,0,0]};
		if (str(_pos) != "[0,0,0]") then {waituntil {_car distance _pos > _dis};_car setdir 0;_curve = false};
		};

	};


_h1 = "helihEmpty" createVehicle _pos;
_h2 = "helihEmpty" createVehicle _pos;
sleep .1;
_driver = "RU_Soldier" createVehicle _pos;
removeallweapons _driver;
_driver allowdamage false;
_driver disableAI "MOVE";
_driver disableAI "ANIM";
_driver setdir getdir _train;
sleep .1;
_train setvariable ["driver",_driver,false];
_train attachto [_driver,[0,-4.5,2.3]];
sleep .1;
_vector = [0,0,.001];
_driver setpos _pos;

_h1 attachto [_train,[0,-7,-1.8]];
_wf attachto [_h1,[0.05,-8.21,0.55]];
_h2 attachto [_wf,[.39,-5.7,1.25]];
_bs attachto [_wf,[0,0,1.2]];
sleep .1;
_driver setpos _pos;
_driver setvectorUp _vector;
_train setvectorUp _vector;
sleep .1;

sleep 10;

// the moving stuff

_dir = getdir _driver;
_vel = velocity _driver;
_speed = 5;
_driver setVelocity [(_vel select 0)+(sin _dir*_speed),(_vel select 1)+(cos _dir*_speed),0];
_a = 0;
_b = 0;
_c = 0;
_delay = 0.4;
_track = (_pos nearestobject (_rail select _b));
_trackpos = position _track;
_trackdir = 0;
_trackold = _track;
_i = _rail select _b;
_newdir = 0;

	while {true} do
	{
	_pos = position _driver;

		if (_track distance _driver < 5) then 
		{
		_stopdelay = 0;
		if (_b == 0) then {_c = 0;};
		if (_rail select _b in _stops) then {_stopdelay = _stoptime;if !(alive _gunner) then {[_tgun,_pos,_group] spawn _gunnercode};};
		if (_b >= _mynum) then {_c = 1;};
		if (_c == 0) then {_b = _b + 1}else{_b = _b - 1};
		_i = _rail select _b;
		if (_i in _hornblow) then {[_train] spawn _horn};
		if (_i in _stops) then {[_train] spawn _horn;};
		_track = (_pos nearestobject _i);
		_trackpos = position _track;
		sleep _stopdelay;
		}else{
		_ang = ((_trackpos select 0)-(_pos select 0)) atan2 ((_trackpos select 1)-(_pos select 1));
		_trackdir = ((_ang + 360) % 360);
		_newdir = ((direction _train) - _trackdir);
		if ((abs _newdir > 2) && (_trackold != _track)) then {_trackold = _track;{[_newdir,_train,_x] spawn _link} foreach _cars;}; 
		sleep _delay;
		_driver setdir _trackdir;
		};

	_dir = getdir _driver;
	_vel = velocity _driver;
	_speed = if (speed _driver < _topspeed) then {2.2}else{0};
	if (speed _driver < 10) then {_delay = 0.077}else{_delay = 0.13};
	_driver setVelocity [(_vel select 0)+(sin _dir*_speed),(_vel select 1)+(cos _dir*_speed),0];
	};

